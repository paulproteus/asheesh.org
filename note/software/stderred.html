<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-AU">
  <head>
   <link rel="openid.server" href="http://www.livejournal.com/openid/server.bml" />
   <link rel="openid.delegate" href="http://paulproteus.livejournal.com/" />
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <meta name="author" content="root"/>
    <meta name="generator" content="Bluefish 1.0.4"/>
    <link rel="alternate" type="application/atom+xml" 
    href="http://asheesh.org/index.atom" />

    <!-- Navigational metadata for large websites (an accessibility feature): -->
    <link rel="top"      href="./index.html" title="Homepage" />
    <link rel="up"       href="./index.html" title="Up" />
    <link rel="first"    href="./index.html" title="First page" />
    <link rel="previous" href="./index.html" title="Previous page" />
    <link rel="next"     href="./index.html" title="Next page" />
    <link rel="last"     href="./index.html" title="Last page" />
    <link rel="toc"      href="./index.html" title="Table of contents" />
    <link rel="index"    href="./index.html" title="Site map" />

<!-- Change the path to your .css file. This should reflect the weblocation -->
    <link rel="stylesheet" type="text/css" href="/html.flav/gila-screen.css" media="screen" title="Gila (screen)" />
    <link rel="stylesheet" type="text/css" href="/html.flav/gila-print.css" media="print" />
	
	<!--  title is pulled from blosxom -->
    <title></title>
  </head>

  <body>
    <!-- For non-visual user agents: -->
      <div id="top"><a href="#main-copy" class="doNotDisplay doNotPrint">Skip to main content.</a></div>

    <!-- ##### Header ##### -->

    <div id="header">
      <h1 class="headerTitle">
     <!-- again the global variables are pulled from blosxom -->
        <a href="/" title="Browse to homepage">Asheeshworld <span>Notes you will like</span></a>
      </h1>

      <div class="subHeader">
        <span class="doNotDisplay">Navigation: </span>
        <!-- change or add the following links to represent what you want -->
        <a href="/about/">About</a> |
        <a href="/mmm/">Mmm</a> |
	<a href="/note/">Notes</a> |
        <a href="/rmad/">RMAD</a> |
        <a href="/dwad/">DWAD</a> |
        <a href="/scribble/">Scribbles</a> |
        <a href="/projects/">Projects</a>
      </div>
    </div>
    <div id="side-bar">

      <!-- ##### Left Sidebar ##### -->
	<!-- If you want to use the Blosxom Plugin "menu" by Fletcher T. Penney, leave this area alone... put the menu file in your plugins dir-->
      <div class="leftSideBar">
        <p class="sideBarTitle">Menu</p>
        <ul>
          <li><a href="/">Home</a></li>
          <li></li>
        </ul>  
        <p class="sideBarTitle">This section</p> 
         <ul><li>Jotted-down notes at the intersection of my mind and permanence</li></ul>
   
        <p class="sideBarTitle">Recycling the past</p>
        <span class="sideBarText">
          
        </span>

        <p class="sideBarTitle">Comments</p>
        <span class="sideBarText">
          Comments are welcome.  Email me.
        </span>
      </div>

	<!-- if you want to manually set up your menus.. commnet above .. and uncomment the following and manipulate to your liking. -->
	<!--
      <div class="leftSideBar">
        <p class="sideBarTitle">This Page</p>
        <ul>
          <li><a href="#introduction">Introduction</a></li>
          <li><a href="#cross-browser" title="Improved cross-browser compatibility">Cross-browser</a></li>
          <li><a href="#stylesheets" title="Modified stylesheets">Stylesheets</a></li>
          <li><a href="#accessibility" title="Improved accessibility">Accessibility</a></li>
        </ul>

        <p class="sideBarTitle">Branch Navigation</p>
        <ul>
          <li><a href="http://www.oswd.org/index.phtml">OSWD Home</a></li>
          <li><a href="http://www.oswd.org/browse.php">Browse Designs</a></li>
          <li><a href="http://www.oswd.org/userinfo.phtml?user=haran">haran&rsquo;s Designs</a></li>
          <li><span class="thisPage" title="That's this page!">Gila Homepage</span></li>
        </ul>

        <p class="sideBarTitle">Comments</p>
        <span class="sideBarText">
          Comments and constructive criticisms are welcome
          <a href="http://www.oswd.org/email.phtml?user=haran" title="Email form">via email</a>.
        </span>
      </div>
	-->


      <!-- ##### Right Sidebar ##### 

      <div class="rightSideBar">
        

        <p class="sideBarTitle">Downloads</p>

        <div class="sideBarText"><strong>"Gila" Skin for Blosxom</strong><br />

      </div>
      -->

    </div>  
         <div id="main-copy">
        <!-- <h1 id="introduction" style="border-top: none; padding-top: 0;"></h1>
       </div>
       -->
<h2>Sun, 28 Sep 2008</h2>
       <h1 id="cross-browser" style="border-top: none; padding-top: 0; padding-bottom: 0;">
        <a href="http://www.asheesh.org/note/software/stderred.html">Colorizing standard error: Adventures in LD_PRELOAD
</a>
       </h1>
		<p>Kristian again asked an interesting question on the <a href="http://www.sf-lug.com/">SF-LUG</a> mailing list.
This time, it was: "<a href="http://linuxmafia.com/pipermail/sf-lug/2008q3/005556.html">How can one get stderr and stdout to appear in different colors?</a>"  He was
asking on behalf of someone, in turn on behalf of a Java programmer.
</p><p>I thought about this and discussed it with Jesse Zbikowski, who I
happened to be sitting next to at the Tenderloin Computer Help Day
that Christian Einfeldt invited the list to (which turned out to be a
lot more interesting and orderly than I had imagined!).
</p><p>Jesse and I talked and we thought of named pipes, which Jesse got to work
on and produced a nice Perl tool for.  I thought about LD_PRELOAD and
got off to a few false starts, and finally came up with a tool
I called <a href="http://git.asheesh.org/?p=zzz/colorize-stderr.git;a=summary">stderred</a> (<a href="http://git.asheesh.org/?p=zzz/colorize-stderr.git;a=snapshot;h=acab1846a3cff48a2e8d2bcbb77f2b5f10503ce4;sf=tgz">tarball of v1.2</a>).  It includes a demo program
in Java and a README.
</p>
<h2 id="w_ld-preload">LD_PRELOAD</h2>
<p>LD_PRELOAD wrappers are a way to change the way a program executes by
replacing library functions, like write() or gettimeofday(), with your
own homebrew versions.  You can think of the dynamic linker as
allowing you to stack your own things "above" the C library, but
"below" the actual program that runs.  So in looking for a symbol (a
function name, typically), the program searches down until it finds
it, and uses that.
</p><p>"stderred" is a C program and a Makefile that you can demonstrate
works properly; it includes a sample Java program and a README.
Because it intercepts the Java JRE's calls to write() to write out
messages to stdout, stderr, or whatever, and only modifies the ones to
stderr, it should be safe to use everywhere.  Plus there are no race
conditions; it runs right in the context of the program, so it also
avoids the performance penalty of context switches.
</p><p>This LD_PRELOAD wrapper is interesting, I think, because (thanks to
Eric Northup for the idea) it calls the real system write() function
by yanking it out of libc using dlopen()+dlsym().  I was also (you can
see this in the first few revisions) trying a #define hack to get
access to libc definitions without the real symbols; however, this
failed a link-time.  I don't see how it could work.
</p>
<h2 id="w_the-problem-with-named-pipes-buffering-can-change-the-order-of-outputted-lines">The problem with named pipes: Buffering can change the order of outputted lines</h2>
<p>Jesse pointed out to me that the named pipe approach has a serious
buffering issue related to timing: if the process writes to stderr and
stdout in quick succession, the lines could appear colorized in the
wrong order.  Jesse shows me some variations of his script that
changed which wrong order it generated, but we couldn't quite figure
out how to make it always right.  This seems like a race condition to
me.
</p><p>That's because when the named pipe in question is read from, the Perl
script doesn't know *how much* to read.  So in this case:
<pre>       one line to stderr
       one line to stdout
       one line to stderr
</pre>
<p>After Jesse explained this to me a few times, I understood it would get
printed as either:
<pre>       one line to stdout
       one line to stderr
       one line to stderr
</pre>
<p>or the same with stderr's lines on top.  Note that the interweaving is
gone; this is because the information of how *much* was printed each
time is thrown away by the OS.  Because the read()s are happening
out-of-process in both the ZSH and Perl ways to do this, I don't see
how they could get around this issue.  An implementation based on
select() or epoll() would have the same issues, I believe.
</p>
<h2 id="w_why-my-solution-doesnt-work-for-ls">Why my solution doesn't work for "ls"</h2>
<p>stderred is as simple as it is because it only overrides write().
The JRE only seems to use write(), not any of the helper functions like 
straight-up printf(), or error(), or fprintf(), that also write to file 
descriptors.  Unfortunately, if you try to stderred-ify "ls", none of   
stderr appears red!  That's because ls uses fprintf_unlocked() and      
error(), which themselves *inside libc* call write().
</p><p>If you think of ls as standing on top of a library stack that looks
like this:
<pre>       ls
       [stderred]
       [libc]
</pre>
<p>if you know that symbol resolution only looks "down," it's clear that
the functions *inside libc* don't go back *up* to stderred to find my
hacked write().  So they use the libc write(), which doesn't colorize.
</p><p>Therefore, I started down the long road of modifying "all the
important" functions to colorize if the output was going to stderr.
Trying to colorize "ls" is where I started, so I wrote quite a few of
those before actually checking what Java used.  "ls" <b>nearly</b> gets
colorized properly; you can look through the with_error branch for the
latest work down that path.  But I stopped once I figured out Java
seems okay with just write(), and for cleanliness's sake I left that
out of the released version (currently 1.1).  Patches welcome!
</p>
<h2 id="w_zsh-python-and-further-reading">zsh, python, and further reading</h2>
<p>According to the Gentoo-Wiki, zsh users have an <a href="http://gentoo-wiki.com/Zsh">easy way to enable colorizing stderr</a>.  Knowing little about zsh
but something about UNIX, it seems to me when they fork to run the new
program, they close() fd #2 (stderr) and open it as a pipe to this
program.  I don't see how they solve the races brought up by the Perl 
thing; it seems to me they'd have the same race.
</p><p>This is the same path that Jesse and I started down in the beginning; we
read http://tldp.org/HOWTO/Bash-Prog-Intro-HOWTO-3.html and noticed it  
didn't discuss setting stderr to a pipe, and then we talked about named
pipes....
</p><p>The Pythonic way to do this would have been to "simply" globally
override what <b>"sys.stderr"</b> is.  I don't know if such a thing is
possible in Java.
</p><p>You can read a quick tutorial on LD_PRELOAD in the IBM DeveloperWorks article,
"<a href="http://www.ibm.com/developerworks/linux/library/l-glibc.html">Override the GNU C Library -- Painlessly</a>."  You
can read a lot more about dynamic linking in the exhaustive
"<a href="http://people.redhat.com/drepper/dsohowto.pdf">How To Write Shared Libraries</a>" by Ulrich Drepper.
</p>
		<p style="text-align: right;">
		<i>[<a href=""></a>] 
		<a href="http://www.asheesh.org/note/software/stderred.html">permanent link and comments</a></i>
		</p>
    
<div class="blosxomEntry">
  <div id="comments" class="blosxomComments">
</div>
<div class="blosxomCommentForm">

  <p><strong>Comment form</strong></p>
  <ul>
    <li>
      The following HTML is supported: &lt;a href&gt;, &lt;em&gt;,
      &lt;i&gt;, &lt;b&gt;, &lt;blockquote&gt;, &lt;br/&gt;,
      &lt;p&gt;, &lt;abbr&gt;, &lt;acronym&gt;, &lt;big&gt;,
      &lt;cite&gt;, &lt;code&gt;, &lt;dfn&gt;, &lt;kbd&gt;,
      &lt;pre&gt;, &lt;small&gt; &lt;strong&gt;, &lt;sub&gt;,
      &lt;sup&gt;, &lt;tt&gt;, &lt;var&gt;
    </li>
    <li>
      I do not display your email address.  It is for my personal use
      only.
    </li>
  </ul>

  <a name="comment_anchor" id="comment-anchor"></a>

  <p id="blosxomCommentStatus"></p>

  <form method="post" action="http://www.asheesh.org/note/software/stderred#comment_anchor"
        id="comments_form" onsubmit="updateStatus();">
    <fieldset>
      <input type="hidden" name="secretToken" value="pleaseDontSpam" />
      <input name="parent" type="hidden" value="note/software/stderred" />
      <input name="title" type="hidden" value="Colorizing standard error: Adventures in LD_PRELOAD
" />
      <table width="100%">
        <tr>
          <td>Name:&nbsp;</td>
          <td><input name="author" size="40" type="text"
                     value="" /></td>
        </tr><tr>
          <td>Your email address:&nbsp;</td>
          <td><input name="email" size="40" type="text"
                     value="" /></td>
        </tr><tr>
          <td>Your website:&nbsp;</td>
          <td><input name="url" size="40" type="text"
                     value="" /></td>
        </tr><tr><td>&nbsp;</td></tr><tr>
          <td colspan="2">Comment:</td>
        </tr><tr>
          <td colspan="2">
            <textarea name="body" rows="10" cols="72"></textarea>
          </td>
        </tr>
        <tr><td>
            <input value="Preview" name="preview" type="submit"
                   id="preview-post" />
            <input value="Post" name="post" type="submit" id="post-post" />
        </td></tr>
      </table>
    </fieldset>
  </form>

</div> <!-- ends blosxomCommentForm div -->

</div> <!-- ends blosxomComments div -->
</div> <!-- end main copy div  -->
    <!-- ##### Footer ##### -->

    <div id="footer">
      <div class="doNotPrint">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">
<img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" />
</a>
      </div>

      <div>
        Copyright &copy; <a href="http://www.asheesh.org/">Asheesh Laroia</a>.  This work is licensed under a 
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">by-sa</a>. <a href="http://www.openhatch.org/">Open Hatch</a> is my current project. You should enjoy my parents' <a href="http://amayabarandgrill.com/">Indian restaurant in Rochester</a>!
      </div>
    </div>
  </body>
</html>
